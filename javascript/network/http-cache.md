# HTTP Cache

- The http cache stores response associated with a request and reuses the stored response for subsequent request
- Reduce the load on server
- The closer the client and cache are, the faster the response will be

### Types of cache

- Two main types of cache: Private cache and shared cache

#### Private cache

- Tied to specified client - typically browser cache
- Not shared with other clients
- Can store a personalized response for user
- If response contains personalized content, you can store the response in private cache with:

```
Cache-Control: private
```

#### Shared cache

- Located between client and the server and can store responses that can shared among users
- Can be sub-classified into proxy cache and managed cache

**Proxy cache**

- Add function of access control
- Implement caching to reduce traffic out of network

**Managed cache**

- To offload origin server and to deliver content efficiently
- Eg. reverse proxies, CDN, and service worker in combination with the Cache API

### Fresh and stale based on age

- Two state of stored HTTP response: fresh and stale
- Fresh state indicated that the response is still valid and can be reused
- Stale state means that cache response has already expired
- Criterion to determine when a response is fresh or stale is `age`

```
HTTP/1.1 200 OK
Content-Type: text/html
Content-Length: 1024
Date: Tue, 22 Feb 2022 22:22:22 GMT
Cache-Control: max-age=604800

<!doctype html>
```

### Expires

- Used to specified the lifetime of the cache using an explicit time rather than specifying an elapsed time
- The time format in `Expires` is difficult to parse, many implementation bugs were found
- `max-age` was adopted in HTTP/1.1
- If both `Expires` and `Cache-Control: max-age` are available, `max-age` is to be preferred

```
Expires: Tue, 28 Feb 2022 22:22:22 GMT
```

### Validation

- Stale responses are not immediately discarded, HTTP has a mechanism to transform a stale response into a fresh one by asking the server
- This is called validation or revalidation
- Validation is done using conditional request that includes `If-Modified-Since` or `If-None-Match` request header

```sh
# Client sending request to ask server if there has been changes made
GET /index.html HTTP/1.1
Host: example.com
Accept: text/html
If-Modified-Since: Tue, 22 Feb 2022 22:00:00 GMT

# Server response with Not Modified and without body 
HTTP/1.1 304 Not Modified
Content-Type: text/html
Date: Tue, 22 Feb 2022 23:22:22 GMT
Last-Modified: Tue, 22 Feb 2022 22:00:00 GMT
Cache-Control: max-age=3600
```

### ETag

- Short for entity tag
- Identifier for a specific version of a resource
- Is an arbitrary value generated by the server
- No restriction on how server must generate the value; can be hash of the body contents or a version number
- ETag allows cache to be more efficient and save bandwidth
- ETag takes precedence over Last-Modified if both exist in the header

```sh
# W/ indicates weak validator is used. Easy to indicate but far less usefull for comparison
ETag: W/"<etag_value>"

# Entity tag that uniquely represent the requested resource; a string of ASCII charaters placed between double quotes
ETag: "<etag_value>"
```

```sh
# Example if the hash value is used as the ETag header
HTTP/1.1 200 OK
Content-Type: text/html
Content-Length: 1024
Date: Tue, 22 Feb 2022 22:22:22 GMT
ETag: "33a64df5"
Cache-Control: max-age=3600

<!doctype html>


# If the response is stale, the client takes the value of the ETag response header for the cached repsonse,
# and put it in If-None-Match request header, to ask the server if the resource has been modified
GET /index.html HTTP/1.1
Host: example.com
Accept: text/html
If-None-Match: "33a64df5"
```

### Reference

- [Http Cache](https://developer.mozilla.org/en-US/docs/Web/HTTP/Caching)
- [ETag](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag)
